@page "/rooms/{RoomId}"

@using LanternCardGame.Pages.Components

@implements IDisposable
@attribute [Authorize]

@inject GameRoomsService roomsService
@inject NavigationManager navManager
@inject CurrentUserService userService
@inject GameService gameService
@inject NotifyService notifyService

@if (this.room != null)
{
    <h3>Room @this.room?.Name</h3>
    <p>@this.room?.PlayerCount / @this.room?.MaxPlayers</p>

    <div class="font-weight-bold">Players:</div>
    <ul class="list-group list-group-flush mb-3">
        @foreach (var player in room?.Players ?? new PlayerModel[0])
        {
            <li class="list-group-item">@player?.Username</li>
        }
    </ul>

    <div class="mb-3">
        @if (this.room?.OwnerId == this.userService.UserId)
        {
            <button class="btn btn-outline-primary mr-2" disabled="@(this.room?.PlayerCount < this.room?.MaxPlayers ? true : false)" @onclick="this.StartGame">Start Game</button>
            <button class="btn btn-outline-danger" @onclick=" () => this.DeleteRoom()">Delete Room</button>
        }
        else
        {
            <button class="btn btn-outline-warning" @onclick=" () => this.LeaveRoom()">Leave Room</button>
        }
    </div>

    <br />
    <div id="chat">
        <ChatComponent RoomId="@this.RoomId" />
    </div>
}

@code {
    [Parameter]
    public string RoomId { get; set; }

    public ChatInputModel chatModel = new ChatInputModel();
    private GameRoomModel room;
    private ICollection<string[]> subscriptionsInfo = new HashSet<string[]>();

    protected override void OnInitialized()
    {
        this.room = this.roomsService.GetRoom(this.RoomId);
        if (this.room == null ||
            (this.room != null && (this.room.InGame || !this.roomsService.IsPlayerInTheRoom(this.userService.InstanceId, this.RoomId))))
        {
            this.navManager.NavigateTo("/rooms", true);
        }

        base.OnInitialized();
    }

    protected override void OnAfterRender(bool firstRender)
    {
        if (!firstRender)
        {
            base.OnAfterRender(firstRender);
            return;
        }

        this.subscriptionsInfo.Add(this.notifyService.Subscribe(this.userService.InstanceId, "RefreshRoom", async () => await RefreshRoom()));
        this.subscriptionsInfo.Add(this.notifyService.Subscribe(this.userService.InstanceId, "RoomDeleted", this.Deleted));
        this.subscriptionsInfo.Add(this.notifyService.Subscribe(this.userService.InstanceId, "GameStarting", () => this.navManager.NavigateTo($"/game/{this.RoomId}")));
        base.OnAfterRender(firstRender);
    }

    public void Deleted()
    {
        this.navManager.NavigateTo("/rooms");
    }

    public void StartGame()
    {
        this.roomsService.StartGame(this.RoomId);
        this.gameService.StartGame(this.RoomId);
    }

    public void DeleteRoom(bool navigate = true)
    {
        this.roomsService.DeleteRoom(this.RoomId);
        this.room = this.roomsService.GetRoom(this.RoomId);
        if (navigate)
        {
            this.navManager.NavigateTo("/rooms");
        }
    }

    public void LeaveRoom(bool navigate = true)
    {
        this.roomsService.RemovePlayerFromRoom(userService.UserId, this.RoomId);
        if (navigate)
        {
            this.navManager.NavigateTo("/rooms");
        }
    }

    public async Task RefreshRoom()
    {
        this.room = this.roomsService.GetRoom(this.RoomId);
        await this.InvokeAsync(this.StateHasChanged);
    }

    public void Dispose()
    {
        foreach (var subscriptionInfo in this.subscriptionsInfo)
        {
            this.notifyService.Unsubscribe(subscriptionInfo[0], subscriptionInfo[1]);
        }

        this.room = this.roomsService.GetRoom(RoomId);
        if (room != null && !this.room.InGame)
        {

            if (this.userService.UserId == this.room.OwnerId)
            {
                this.DeleteRoom(false);
            }
            else
            {
                this.LeaveRoom(false);
            }
        }
    }
}
